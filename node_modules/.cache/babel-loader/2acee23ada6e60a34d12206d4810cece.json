{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.systemEvents = void 0;\n\nvar _message = _interopRequireDefault(require(\"../api/message\"));\n\nvar _framework7Esm = _interopRequireDefault(require(\"framework7/framework7.esm.bundle\"));\n\nvar _stompjs = require(\"@stomp/stompjs\");\n\nvar _toolkit = require(\"@hvisions/toolkit\");\n\nvar _moment = _interopRequireDefault(require(\"moment\"));\n\nvar _toastStyle = _interopRequireDefault(require(\"./toastStyle.scss\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nvar EventEmitter = require('events');\n\nvar systemEvents = new EventEmitter();\nexports.systemEvents = systemEvents;\nvar stompClient = null;\n\nvar hint = function hint() {\n  _framework7Esm.default.instance.view.main.router.app.toast.create({\n    text: '你收到一条新的消息',\n    icon: (0, _moment.default)().format('hh:mm'),\n    position: 'top',\n    closeTimeout: 2000,\n    cssClass: \"\".concat(_toastStyle.default.toastSuccess, \" ne-toast\")\n  }).open();\n};\n\nsystemEvents.addListener('message-ws-establish', function () {\n  if (stompClient && stompClient.active) {\n    return;\n  }\n\n  _message.default.getMqInfo().then(function (res) {\n    var account = res.account,\n        password = res.password,\n        host = res.host,\n        port = res.port;\n    var stompConfig = {\n      connectHeaders: {\n        login: account,\n        passcode: password\n      },\n      brokerURL: \"ws://\".concat(host, \":\").concat(port, \"/ws\"),\n      reconnectDelay: 200,\n      onConnect: function onConnect(frame) {\n        var subscription = stompClient.subscribe(\"/\".concat('exchange', \"/\", 'h-visions.message', \"/\", _toolkit.session.getAuthData().id), function (message) {\n          if (message.body) {\n            hint();\n          }\n        });\n      },\n      onStompError: function onStompError(frame) {\n        console.log('Broker reported error: ' + frame.headers['message']);\n        console.log('Additional details: ' + frame.body);\n      }\n    };\n\n    if (!stompClient) {\n      stompClient = new _stompjs.Client(stompConfig);\n    }\n\n    if (!stompClient.active) {\n      stompClient.activate();\n    }\n  }).catch(function (err) {\n    _framework7Esm.default.instance.view.main.router.app.toast.create({\n      text: '消息连接失败',\n      icon: (0, _moment.default)().format('hh:mm'),\n      position: 'top',\n      closeTimeout: 2000,\n      cssClass: \"\".concat(_toastStyle.default.toastError, \" ne-toast\")\n    }).open();\n  });\n});\nsystemEvents.addListener('message-ws-disconnect', function () {\n  if (stompClient) {\n    stompClient.deactivate();\n  }\n});","map":null,"metadata":{},"sourceType":"script"}